@{
    ViewData["Title"] = "Numpad";
}

<h3>@ViewData["Title"] <small>Store: @ViewData["Store"]</small></h3>

<p>Register new purchase order:</p>

<form id="register">
    <input type="tel" name="amount" id="amount" />
    <input type="hidden" name="currency" value="SEK" />
    <input type="hidden" name="store" value="gagga" />
    <input type="submit" />
</form>

@section scripts {
    <script>

    var store = '@ViewData["Store"]';
    var connection;
    
    $(document).ready(function(){
        
        connection = connection = new signalR.HubConnectionBuilder()
                                             .withUrl("/transactionHub")
                                             .configureLogging(signalR.LogLevel.Information)
                                             .build();

        connection.on("SendMessage", function (sender, message) {
            console.log(sender + ': ' + message);
        });
            
        connection.on("Send", function (message) {
             console.log(message);
        });

        connection.on("SendAction", function (sender, action) {
            console.log("SendAction: " + sender + ' ' + action);
        });
            
        connection.on("Notify", function (data) {
            Toastify({
                    text: "Notify: " + data,
                    duration: 1000,
                    gravity: "bottom",
                    positionLeft: false,
                    close: true,
                    }).showToast();
        });
        
        connection.on("StoreBalance", function (balance, currency) {
            Toastify({
                    text: "StoreBalance: " + balance + " " + currency,
                    duration: 1000,
                    gravity: "bottom",
                    positionLeft: false,
                    close: true,
                    }).showToast();
        });
            
        /*
        connection.on("PurchaseOrderRegistered", function (groupName, orderId, amount, currency) {
            console.log("PurchaseOrderRegistered: " + groupName + ' ' + amount + ' ' + currency);
        });
        */
        
        connection.on("PurchaseOrderRegistered", function (groupName, orderId, amount, currency) {
            
            Toastify({
                    text: "PurchaseOrderRegistered: " + amount + " " + currency,
                    duration: 1000,
                    gravity: "bottom",
                    positionLeft: false,
                    close: true,
                    }).showToast();
        });
        
        connection.on("PurchaseOrderAccepted", function (groupName, orderId, amount, currency) {
            
            Toastify({
                    text: "Accepted: " + amount + " " + currency,
                    duration: 3000,
                    gravity: "bottom",
                    positionLeft: false,
                    close: true,
                    }).showToast();
        });
            
        connection.start().then(function() {
            connection.send('Subscribe', 'Store' + store);
        });

        $('#register').on('submit', function(e){
            var amount = e.target.querySelector("input[name='amount']");
            
            connection.send('RegisterPurchaseOrder', 'Store' + store, 'Order-' + Math.floor(Math.random() * 1000), amount.value, 'SEK');
            e.preventDefault();
            return false;
        })
            
    });
    </script>
}